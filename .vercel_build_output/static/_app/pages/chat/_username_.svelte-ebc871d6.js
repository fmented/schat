import{S as $,i as x,s as ee,e as D,t as P,c as I,a as y,h as V,d as w,g as H,J as o,j as G,k as j,m as B,b as f,W as le,K as re,R as me,Q as K,X as ne,w as _e,x as de,y as ge,q as Y,o as Q,B as pe,Y as be,M as F,n as Ee,p as ke,U as De,N as Ie,v as Se,Z as ie}from"../../chunks/vendor-1841b722.js";import{S as Ue}from"../../chunks/bridge-0fce5198.js";import{s as ze,A as Me}from"../../chunks/index-a1babe66.js";import{s as ve,i as ye,a as J,b as oe}from"../../chunks/helper-7d864c4a.js";function Ae(l){let e,s=l[0].content+"",t;return{c(){e=D("p"),t=P(s),this.h()},l(a){e=I(a,"P",{class:!0});var r=y(e);t=V(r,s),r.forEach(w),this.h()},h(){f(e,"class","svelte-1jb3h5w")},m(a,r){H(a,e,r),o(e,t)},p(a,r){r&1&&s!==(s=a[0].content+"")&&G(t,s)},d(a){a&&w(e)}}}function Te(l){let e,s;return{c(){e=D("img"),this.h()},l(t){e=I(t,"IMG",{src:!0,alt:!0,class:!0}),this.h()},h(){K(e.src,s=l[0].content)||f(e,"src",s),f(e,"alt","unknown"),f(e,"class","svelte-1jb3h5w")},m(t,a){H(t,e,a)},p(t,a){a&1&&!K(e.src,s=t[0].content)&&f(e,"src",s)},d(t){t&&w(e)}}}function ce(l){let e,s=l[0].status==="pending"?"\u23F1":l[0].status==="sending"?"\u{1F4E4}":l[0].status==="sent"?"\u{1F6EB}":l[0].status==="received"?"\u{1F4E6}":"\u{1F441}\u200D\u{1F5E8}",t;return{c(){e=D("span"),t=P(s)},l(a){e=I(a,"SPAN",{});var r=y(e);t=V(r,s),r.forEach(w)},m(a,r){H(a,e,r),o(e,t)},p(a,r){r&1&&s!==(s=a[0].status==="pending"?"\u23F1":a[0].status==="sending"?"\u{1F4E4}":a[0].status==="sent"?"\u{1F6EB}":a[0].status==="received"?"\u{1F4E6}":"\u{1F441}\u200D\u{1F5E8}")&&G(t,s)},d(a){a&&w(e)}}}function Re(l){let e,s,t,a,r,i,S=new Date(l[0].timeStamp).getDate()+"",M,A,c=new Date(l[0].timeStamp).getMonth()+"",h,U,d=new Date(l[0].timeStamp).getHours()+"",m,L,z=new Date(l[0].timeStamp).getMinutes()+"",N,W;function T(n,g){return g&1&&(t=null),t==null&&(t=!!n[0].content.startsWith("data:image")),t?Te:Ae}let C=T(l,-1),E=C(l),u=l[0].from===l[1].user&&ce(l);return{c(){e=D("div"),s=D("div"),E.c(),a=j(),r=D("div"),i=D("span"),M=P(S),A=j(),h=P(c),U=P(`\r
                @ `),m=P(d),L=P(" : "),N=P(z),W=j(),u&&u.c(),this.h()},l(n){e=I(n,"DIV",{class:!0});var g=y(e);s=I(g,"DIV",{class:!0});var q=y(s);E.l(q),a=B(q),r=I(q,"DIV",{class:!0});var k=y(r);i=I(k,"SPAN",{});var R=y(i);M=V(R,S),A=B(R),h=V(R,c),U=V(R,`\r
                @ `),m=V(R,d),L=V(R," : "),N=V(R,z),R.forEach(w),W=B(k),u&&u.l(k),k.forEach(w),q.forEach(w),g.forEach(w),this.h()},h(){f(r,"class","svelte-1jb3h5w"),f(s,"class","msg svelte-1jb3h5w"),f(e,"class","wrap svelte-1jb3h5w"),le(e,"right",l[0].from===l[1].user)},m(n,g){H(n,e,g),o(e,s),E.m(s,null),o(s,a),o(s,r),o(r,i),o(i,M),o(i,A),o(i,h),o(i,U),o(i,m),o(i,L),o(i,N),o(r,W),u&&u.m(r,null)},p(n,[g]){C===(C=T(n,g))&&E?E.p(n,g):(E.d(1),E=C(n),E&&(E.c(),E.m(s,a))),g&1&&S!==(S=new Date(n[0].timeStamp).getDate()+"")&&G(M,S),g&1&&c!==(c=new Date(n[0].timeStamp).getMonth()+"")&&G(h,c),g&1&&d!==(d=new Date(n[0].timeStamp).getHours()+"")&&G(m,d),g&1&&z!==(z=new Date(n[0].timeStamp).getMinutes()+"")&&G(N,z),n[0].from===n[1].user?u?u.p(n,g):(u=ce(n),u.c(),u.m(r,null)):u&&(u.d(1),u=null),g&3&&le(e,"right",n[0].from===n[1].user)},i:re,o:re,d(n){n&&w(e),E.d(),u&&u.d()}}}function Le(l,e,s){let t;me(l,ve,r=>s(1,t=r));let{message:a}=e;return l.$$set=r=>{"message"in r&&s(0,a=r.message)},[a,t]}class Ne extends ${constructor(e){super();x(this,e,Le,Re,ee,{message:0})}}async function Pe(l){return new Promise((e,s)=>{const t=new Image,a=document.createElement("canvas"),r=a.getContext("2d");t.src=l,t.onload=()=>{const i=t.height/t.width*150;a.width=150,a.height=i,r.drawImage(t,0,0,150,i),e(a.toDataURL())},t.onerror=i=>s(i)})}function ue(l,e,s){const t=l.slice();return t[8]=e[s],t}function fe(l){let e,s,t,a,r,i,S=l[5].username+"",M,A,c,h,U;return{c(){e=D("div"),s=D("strong"),t=D("a"),a=P("\u{1F519}"),r=j(),i=D("strong"),M=P(S),A=j(),c=D("img"),this.h()},l(d){e=I(d,"DIV",{class:!0});var m=y(e);s=I(m,"STRONG",{});var L=y(s);t=I(L,"A",{href:!0,"aria-label":!0});var z=y(t);a=V(z,"\u{1F519}"),z.forEach(w),L.forEach(w),r=B(m),i=I(m,"STRONG",{class:!0});var N=y(i);M=V(N,S),N.forEach(w),A=B(m),c=I(m,"IMG",{src:!0,alt:!0,height:!0,width:!0}),m.forEach(w),this.h()},h(){f(t,"href","/chat"),f(t,"aria-label","back"),f(i,"class","username svelte-13ztecl"),K(c.src,h=l[5].avatar)||f(c,"src",h),f(c,"alt",U=l[5].username),f(c,"height","30"),f(c,"width","30"),f(e,"class","header svelte-13ztecl")},m(d,m){H(d,e,m),o(e,s),o(s,t),o(t,a),o(e,r),o(e,i),o(i,M),o(e,A),o(e,c)},p(d,m){m&32&&S!==(S=d[5].username+"")&&G(M,S),m&32&&!K(c.src,h=d[5].avatar)&&f(c,"src",h),m&32&&U!==(U=d[5].username)&&f(c,"alt",U)},d(d){d&&w(e)}}}function he(l){let e,s;return e=new Ne({props:{message:l[8]}}),{c(){_e(e.$$.fragment)},l(t){de(e.$$.fragment,t)},m(t,a){ge(e,t,a),s=!0},p(t,a){const r={};a&4&&(r.message=t[8]),e.$set(r)},i(t){s||(Y(e.$$.fragment,t),s=!0)},o(t){Q(e.$$.fragment,t),s=!1},d(t){pe(e,t)}}}function Ve(l){let e=!1,s=()=>{e=!1},t,a,r,i,S,M,A,c,h,U,d,m,L,z,N,W,T,C,E,u,n,g,q;ne(l[12]);let k=l[5]&&fe(l),R=l[2],p=[];for(let _=0;_<R.length;_+=1)p[_]=he(ue(l,R,_));const we=_=>Q(p[_],1,1,()=>{p[_]=null});return{c(){a=D("div"),k&&k.c(),r=j(),i=D("div");for(let _=0;_<p.length;_+=1)p[_].c();M=j(),A=D("div"),c=D("div"),h=D("label"),U=P("msg"),d=j(),m=D("input"),L=j(),z=D("label"),N=P("pic"),W=j(),T=D("input"),C=j(),E=D("span"),u=P("\u{1F4CE}"),this.h()},l(_){a=I(_,"DIV",{class:!0});var v=y(a);k&&k.l(v),r=B(v),i=I(v,"DIV",{class:!0});var b=y(i);for(let Z=0;Z<p.length;Z+=1)p[Z].l(b);b.forEach(w),M=B(v),A=I(v,"DIV",{class:!0});var X=y(A);c=I(X,"DIV",{class:!0});var O=y(c);h=I(O,"LABEL",{for:!0,class:!0});var te=y(h);U=V(te,"msg"),te.forEach(w),d=B(O),m=I(O,"INPUT",{type:!0,id:!0,placeholder:!0,class:!0}),L=B(O),z=I(O,"LABEL",{for:!0,class:!0});var se=y(z);N=V(se,"pic"),se.forEach(w),W=B(O),T=I(O,"INPUT",{type:!0,id:!0,accept:!0,class:!0}),C=B(O),E=I(O,"SPAN",{class:!0});var ae=y(E);u=V(ae,"\u{1F4CE}"),ae.forEach(w),O.forEach(w),X.forEach(w),v.forEach(w),this.h()},h(){f(i,"class","chat svelte-13ztecl"),ne(()=>l[13].call(i)),f(h,"for","msg"),f(h,"class","svelte-13ztecl"),f(m,"type","text"),f(m,"id","msg"),f(m,"placeholder","type something"),m.disabled=l[1],f(m,"class","svelte-13ztecl"),f(z,"for","pic"),f(z,"class","svelte-13ztecl"),f(T,"type","file"),f(T,"id","pic"),f(T,"accept","image/*"),T.disabled=l[1],f(T,"class","svelte-13ztecl"),f(E,"class","svelte-13ztecl"),f(c,"class","svelte-13ztecl"),f(A,"class","form svelte-13ztecl"),f(a,"class","wrap")},m(_,v){H(_,a,v),k&&k.m(a,null),o(a,r),o(a,i);for(let b=0;b<p.length;b+=1)p[b].m(i,null);S=be(i,l[13].bind(i)),o(a,M),o(a,A),o(A,c),o(c,h),o(h,U),o(c,d),o(c,m),o(c,L),o(c,z),o(z,N),o(c,W),o(c,T),l[15](T),o(c,C),o(c,E),o(E,u),l[17](a),n=!0,g||(q=[F(window,"scroll",()=>{e=!0,clearTimeout(t),t=setTimeout(s,100),l[12]()}),F(m,"keypress",l[7]),F(T,"change",l[14]),F(E,"click",l[16])],g=!0)},p(_,[v]){if(v&64&&!e&&(e=!0,clearTimeout(t),scrollTo(window.pageXOffset,_[6]),t=setTimeout(s,100)),_[5]?k?k.p(_,v):(k=fe(_),k.c(),k.m(a,r)):k&&(k.d(1),k=null),v&4){R=_[2];let b;for(b=0;b<R.length;b+=1){const X=ue(_,R,b);p[b]?(p[b].p(X,v),Y(p[b],1)):(p[b]=he(X),p[b].c(),Y(p[b],1),p[b].m(i,null))}for(Ee(),b=R.length;b<p.length;b+=1)we(b);ke()}(!n||v&2)&&(m.disabled=_[1]),(!n||v&2)&&(T.disabled=_[1])},i(_){if(!n){for(let v=0;v<R.length;v+=1)Y(p[v]);n=!0}},o(_){p=p.filter(Boolean);for(let v=0;v<p.length;v+=1)Q(p[v]);n=!1},d(_){_&&w(a),k&&k.d(),De(p,_),S(),l[15](null),l[17](null),g=!1,Ie(q)}}}function je(l,e,s){let t;me(l,ve,u=>s(11,t=u));let{withUser:a}=e,r=[],i,S,M,A,c,h,U;Se(async()=>{if(s(10,h=ye(t.user)),await h.open(),await h.tables.profile.has({username:a}))s(5,U=await h.tables.profile.findOne({username:a}));else{const n=await(await ze(Me.AUTH_DETAIL,{username:a})).json();s(5,U={username:a,avatar:n.avatar,bio:n.bio})}s(2,r=await J(h,a)),await h.close(),S=new Ue(navigator.serviceWorker),await S.emit("open",t.user),S.on("update",async n=>{!h||s(2,r=await J(h,a))}),S.on("profile_update",n=>{U.username===n.username&&s(5,U=n)})});let d=!1;async function m(u){if(!h||d)return;s(1,d=!0);const n=u.target;if(u.key==="Enter"){const g=n.value;await oe(h,{from:t.user,to:a,content:g}),n.value="",s(2,r=await J(h,a))}s(1,d=!1)}let L;function z(){s(6,L=window.pageYOffset)}function N(){L=this.clientHeight,s(6,L)}function W(){i=this.files,s(0,i),s(10,h),s(1,d),s(11,t),s(9,a)}function T(u){ie[u?"unshift":"push"](()=>{c=u,s(4,c)})}const C=()=>c.click();function E(u){ie[u?"unshift":"push"](()=>{M=u,s(3,M)})}return l.$$set=u=>{"withUser"in u&&s(9,a=u.withUser)},l.$$.update=()=>{if(l.$$.dirty&3587&&i){const u=i[0],n=new FileReader;n.readAsDataURL(u),n.onload=async()=>{const g=await Pe(n.result);!h||d||(s(1,d=!0),await oe(h,{from:t.user,to:a,content:g}),s(2,r=await J(h,a)),s(0,i=void 0),s(1,d=!1))}}},[i,d,r,M,c,U,L,m,A,a,h,t,z,N,W,T,C,E]}class Be extends ${constructor(e){super();x(this,e,je,Ve,ee,{withUser:9})}}function Ce(l){let e,s;return e=new Be({props:{withUser:l[0]}}),{c(){_e(e.$$.fragment)},l(t){de(e.$$.fragment,t)},m(t,a){ge(e,t,a),s=!0},p(t,[a]){const r={};a&1&&(r.withUser=t[0]),e.$set(r)},i(t){s||(Y(e.$$.fragment,t),s=!0)},o(t){Q(e.$$.fragment,t),s=!1},d(t){pe(e,t)}}}const Xe=async({session:l,params:e,fetch:s})=>l.user?l.user===e.username?{status:301,redirect:"/chat"}:{props:{u:e.username}}:{status:301,redirect:"/"};function Oe(l,e,s){let{u:t}=e;return l.$$set=a=>{"u"in a&&s(0,t=a.u)},[t]}class Ye extends ${constructor(e){super();x(this,e,Oe,Ce,ee,{u:0})}}export{Ye as default,Xe as load};
